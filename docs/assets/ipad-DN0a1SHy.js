import"./modulepreload-polyfill-B5Qt9EMX.js";import{_ as P}from"./preload-helper-BNaQLqFv.js";import{b as C,C as l,a as S,r as I,c as g,T as v}from"./config-uyDoNbnC.js";const L="https://fwcdxvnpcpyxywbjwyaa.supabase.co",b="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3Y2R4dm5wY3B5eHl3Ymp3eWFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5OTg5NjMsImV4cCI6MjA3MzU3NDk2M30.XEfxRw39wp5jMs3YWFszhFZ1_ZXOilraSBN8R1e3LOI",E="gallerybucket";let h;const f=/iPad/.test(navigator.userAgent)||/Macintosh/.test(navigator.userAgent)&&"ontouchend"in document,c=()=>{var s;const i=((s=screen.orientation)==null?void 0:s.type)||(window.innerWidth>window.innerHeight?"landscape":"portrait"),t=i.includes("landscape");return{type:i,isLandscape:t,isPortrait:!t,width:window.innerWidth,height:window.innerHeight}},B=i=>{const t=c(),e={facingMode:{ideal:i},frameRate:{ideal:30,max:60},width:{ideal:t.isLandscape?1920:1080,max:t.isLandscape?1920:1080},height:{ideal:t.isLandscape?1080:1920,max:t.isLandscape?1080:1920}};return console.log(`[iPad] Camera constraints for ${i} (${t.type}):`,e),e},A=new TextEncoder,T=new TextDecoder,d=i=>A.encode(typeof i=="string"?i:JSON.stringify(i)),o=(...i)=>console.log("[RemoteAPI]",...i);let r={names:[],collected:{},t:Date.now()};const p="bayou_collected_items",u="reloadReason";function w(i){try{localStorage.setItem(p,JSON.stringify(i)),o("State saved to cache:",i)}catch(t){console.error("Failed to save state to cache:",t)}}function k(){try{const i=localStorage.getItem(p);if(i){const t=JSON.parse(i);return o("State loaded from cache:",t),t}}catch(i){console.error("Failed to load state from cache:",i)}return null}function D(){sessionStorage.setItem(u,"switchCamera"),o("Marked camera switch in session storage")}function R(){return sessionStorage.getItem(u)==="switchCamera"?(sessionStorage.removeItem(u),o("Detected camera switch reload"),!0):(o("Normal page load (not camera switch)"),!1)}function y(i){const t=Array.isArray(i==null?void 0:i.names)?i.names.map(String):[],e=i!=null&&i.collected&&typeof i.collected=="object"?i.collected:{},s={};t.forEach(n=>s[n]=e[n]===void 0?!0:!!e[n]),Object.keys(e).forEach(n=>{e[n]&&(s[n]=!0,t.includes(n)||t.push(n))});const a=Number.isFinite(i==null?void 0:i.t)?i.t:Date.now();return{names:t,collected:s,t:a}}let M=0;const O=()=>({apiSpecId:l.API_SPEC_ID,getRequestHandler(i){const t=(i==null?void 0:i.body)&&(i.body.byteLength??i.body.length)||0;if(o("REQ",`endpoint=${i.endpointId}`,`params=${JSON.stringify(i.parameters||{})}`,`body=${t}B`),i.endpointId==="ping"){const e=++M,s=performance.now();return a=>{a({status:"success",metadata:{n:String(e)},body:d({pong:!0,t:Date.now(),n:e})}),o("RES",`ping #${e}`,`${Math.round(performance.now()-s)}ms`)}}if(i.endpointId==="get_state"){const e=performance.now();return s=>{s({status:"success",metadata:{count:String(r.names.length)},body:d(r)}),o("RES","get_state",`${Math.round(performance.now()-e)}ms`,r)}}if(i.endpointId==="set_state"){const e=performance.now();return s=>{var a;try{let n=(a=i.parameters)==null?void 0:a.payload;if(n==null&&i.body&&(n=T.decode(i.body)),typeof n!="string"){s({status:"bad_request",metadata:{},body:d('missing or invalid "payload" (expected stringified JSON)')});return}const m=JSON.parse(n);r=y(m),w(r),s({status:"success",metadata:{count:String(r.names.length)},body:d({ok:!0})}),o("RES","set_state",`${Math.round(performance.now()-e)}ms`,"Updated gameState:",r)}catch(n){s({status:"server_error",metadata:{},body:d(String((n==null?void 0:n.message)||n))})}}}}});class F{constructor(){this.outputContainer=document.getElementById("app"),this.captureButton=document.getElementById("captureButton"),this.photoPreview=document.getElementById("photoPreview"),this.previewImage=document.getElementById("previewImage"),this.retakeButton=document.getElementById("retakeButton"),this.saveButton=document.getElementById("saveButton"),this.lastCapturedBlob=null,this.cameraKit=null,this.session=null,this.mediaStream=null,this.lensActive=!1,this.currentLens=null,this.currentFacingMode="environment",this.lastTap=0,this.tapTimeout=null,this.backgroundAudio=document.getElementById("backgroundAudio"),this.liveCanvas=null,this.orientationHandler=null,this.lastOrientation=c(),this.orientationChangeTimeout=null,this.isIPadDevice=f,console.log(`[iPad] Device detected: ${this.isIPadDevice?"iPad":"Other"}`),console.log("[iPad] Initial orientation:",this.lastOrientation),this.initializeApp()}async initializeApp(){if(R()){const t=k();t&&(r=y(t),o("Restored state from cache after camera switch:",r))}else localStorage.removeItem(p),o("Manual refresh detected - cache cleared, starting fresh");await this.initializeSupabase(),this.setupCaptureButton(),this.setupPreviewControls(),this.setupIPadGestures(),this.setupBackgroundAudio(),this.setupIPadOrientationHandling(),await this.initializeCameraKit(),await this.autoStartWithLens()}async initializeSupabase(){try{const{createClient:t}=await P(async()=>{const{createClient:e}=await import("https://esm.sh/@supabase/supabase-js@2");return{createClient:e}},[]);h=t(L,b),console.log("â— Supabase initialized successfully")}catch(t){console.error("â–  Supabase initialization failed:",t)}}setupCaptureButton(){this.captureButton&&(this.captureButton.addEventListener("click",()=>{this.photoPreview&&this.photoPreview.classList.contains("show")?this.hidePhotoPreview():this.capturePhoto()}),this.isIPadDevice&&(this.captureButton.addEventListener("touchstart",t=>{t.preventDefault(),this.captureButton.style.transform="scale(0.95)"}),this.captureButton.addEventListener("touchend",t=>{t.preventDefault(),this.captureButton.style.transform=""})))}setupPreviewControls(){this.retakeButton&&this.retakeButton.addEventListener("click",()=>{this.hidePhotoPreview()}),this.saveButton&&this.saveButton.addEventListener("click",()=>{this.saveToSupabase()})}setupIPadOrientationHandling(){var t;this.isIPadDevice&&(this.orientationHandler=()=>{this.orientationChangeTimeout&&clearTimeout(this.orientationChangeTimeout),this.orientationChangeTimeout=setTimeout(async()=>{const e=c();console.log("[iPad] Orientation changed:",{from:this.lastOrientation.type,to:e.type,dimensions:`${e.width}x${e.height}`}),this.lastOrientation.isLandscape!==e.isLandscape&&await this.handleIPadOrientationChange(e),this.lastOrientation=e},300)},(t=screen.orientation)==null||t.addEventListener("change",this.orientationHandler),window.addEventListener("orientationchange",this.orientationHandler),window.addEventListener("resize",this.orientationHandler))}async handleIPadOrientationChange(t){if(!(!this.session||!this.mediaStream)){console.log(`[iPad] Handling orientation change to ${t.type}`);try{this.mediaStream.getTracks().forEach(e=>e.stop()),await new Promise(e=>setTimeout(e,100)),await this.startCamera(),this.lensActive&&this.currentLens&&await this.session.applyLens(this.currentLens),console.log(`[iPad] Camera restarted for ${t.type} orientation`)}catch(e){console.error("[iPad] Orientation change handling failed:",e)}}}async initializeCameraKit(){try{this.cameraKit=await C({apiToken:l.API_TOKEN,logger:"console"},t=>t.provides(S(I.token,()=>O()))),console.info("[RemoteAPI] provider registered for spec:",l.API_SPEC_ID),this.session=await this.cameraKit.createSession(),window.ckSession=this.session,this.session.events.addEventListener("error",t=>{console.error("Camera Kit error:",t.detail)}),this.liveCanvas=this.session.output.live,this.outputContainer.appendChild(this.liveCanvas),this.liveCanvas.style.width="100%",this.liveCanvas.style.height="100%",this.liveCanvas.style.objectFit="cover",this.liveCanvas.style.display="block",this.liveCanvas.style.background="#000",this.setupIPadCanvasResizing()}catch(t){console.error("Failed to initialize Camera Kit:",t)}}setupIPadCanvasResizing(){const t=()=>{if(!this.isIPadDevice)return Math.min(window.devicePixelRatio||1,2);const s=window.devicePixelRatio||1;return c().isLandscape?Math.min(s,2.5):Math.min(s,2)},e=()=>{if(!this.liveCanvas)return;const s=this.liveCanvas.getBoundingClientRect(),a=t(),n=c();this.liveCanvas.width=Math.round(s.width*a),this.liveCanvas.height=Math.round(s.height*a),console.log(`[iPad] Canvas sized: ${this.liveCanvas.width}x${this.liveCanvas.height} (CSS: ${s.width}x${s.height}, DPR: ${a}, ${n.type})`)};new ResizeObserver(e).observe(this.liveCanvas.parentElement),window.addEventListener("orientationchange",()=>{setTimeout(e,100)}),window.addEventListener("load",e),e()}async startCamera(){try{const t={video:this.isIPadDevice?B(this.currentFacingMode):{facingMode:{ideal:this.currentFacingMode},frameRate:{ideal:30}},audio:!1};console.log("[iPad] Starting camera with constraints:",t),this.mediaStream=await navigator.mediaDevices.getUserMedia(t);const e=g(this.mediaStream);if(await this.session.setSource(e),this.currentFacingMode==="user"&&e.setTransform(v.MirrorX),this.session.play("live"),this.isIPadDevice&&this.mediaStream){const s=this.mediaStream.getVideoTracks()[0];if(s){const a=s.getSettings();console.log("[iPad] Camera stream settings:",{width:a.width,height:a.height,frameRate:a.frameRate,facingMode:a.facingMode})}}}catch(t){console.error("Camera failed:",t),t.name==="OverconstrainedError"&&await this.tryFallbackCamera()}}async tryFallbackCamera(){try{console.log(`[iPad] Trying fallback camera for ${this.currentFacingMode}`);const t={video:{facingMode:this.currentFacingMode,frameRate:{ideal:30}},audio:!1};this.mediaStream=await navigator.mediaDevices.getUserMedia(t);const e=g(this.mediaStream);await this.session.setSource(e),this.currentFacingMode==="user"&&e.setTransform(v.MirrorX),this.session.play("live"),console.log("[iPad] Fallback camera successful")}catch(t){console.error("Fallback camera failed:",t)}}async switchCamera(){if(this.session)try{const t=this.currentFacingMode==="user"?"environment":"user";if(console.log(`[iPad] Switching camera: ${this.currentFacingMode} â†’ ${t}`),this.currentFacingMode==="user"&&t==="environment"){o("[iPad] Switching from front to back camera - reloading page"),D(),w(r),this.mediaStream&&this.mediaStream.getTracks().forEach(e=>e.stop()),window.location.reload();return}o("[iPad] Switching from back to front camera - smooth switch"),this.mediaStream&&this.mediaStream.getTracks().forEach(e=>e.stop()),this.currentFacingMode=t,await this.startCamera(),this.lensActive&&this.currentLens&&await this.session.applyLens(this.currentLens),console.log(`[iPad] Camera switched to: ${this.currentFacingMode}`)}catch(t){console.error("[iPad] Switch failed:",t),this.currentFacingMode==="environment"&&(this.currentFacingMode="user")}}async toggleLens(){if(this.session)try{this.lensActive&&this.currentLens?(await this.session.clearLens(),this.lensActive=!1,this.currentLens=null,console.log("[iPad] Lens cleared")):(this.currentLens=await this.cameraKit.lensRepository.loadLens(l.LENS_ID,l.LENS_GROUP_ID),await this.session.applyLens(this.currentLens),this.lensActive=!0,console.log("[iPad] Lens applied"))}catch(t){console.error("[iPad] Lens error:",t),this.lensActive=!1,this.currentLens=null}}async autoStartWithLens(){try{console.log("[iPad] Auto-starting camera with lens..."),await this.startCamera(),await new Promise(t=>setTimeout(t,1e3)),await this.toggleLens(),console.log("[iPad] Auto-start completed")}catch(t){console.error("[iPad] Auto-start failed:",t)}}capturePhoto(){if(!this.session||!this.liveCanvas){console.error("[iPad] Camera session not ready for capture");return}try{const t=document.createElement("canvas"),e=t.getContext("2d");t.width=this.liveCanvas.width,t.height=this.liveCanvas.height,e.drawImage(this.liveCanvas,0,0);const s=this.isIPadDevice?.95:.92;t.toBlob(a=>{if(a){this.lastCapturedBlob=a;const n=URL.createObjectURL(a);this.previewImage&&this.photoPreview?(this.previewImage.src=n,this.showPhotoPreview()):this.downloadPhoto(a),console.log(`[iPad] Photo captured! Size: ${a.size} bytes`),this.captureButton&&(this.captureButton.style.transform="scale(0.9)",this.captureButton.style.background="rgba(255, 255, 255, 0.3)",setTimeout(()=>{this.captureButton.style.transform="",this.captureButton.style.background=""},200))}},"image/png",s)}catch(t){console.error("[iPad] Photo capture failed:",t)}}showPhotoPreview(){this.photoPreview&&(this.photoPreview.classList.add("show"),this.captureButton&&(this.captureButton.style.opacity="0.8"))}hidePhotoPreview(){this.photoPreview&&this.photoPreview.classList.remove("show"),this.captureButton&&(this.captureButton.style.opacity="1"),this.saveButton&&(this.saveButton.textContent="â†‘",this.saveButton.disabled=!1),this.previewImage&&this.previewImage.src&&(URL.revokeObjectURL(this.previewImage.src),this.previewImage.src=""),this.lastCapturedBlob=null}async saveToSupabase(){if(!this.lastCapturedBlob||!h){console.error("[iPad] Cannot save: Missing photo data or Supabase not initialized");return}try{this.saveButton&&(this.saveButton.textContent="â—â—â—",this.saveButton.disabled=!0);const t=Date.now(),s=`ipad-snap-${c().type}-${t}.png`;console.log(`[iPad] Uploading photo to Supabase: ${s}`);const{data:a,error:n}=await h.storage.from(E).upload(s,this.lastCapturedBlob,{contentType:"image/png"});if(n)throw n;console.log(`[iPad] Photo saved to Supabase: ${s}`),this.saveButton&&(this.saveButton.textContent="âœ“",setTimeout(()=>{this.hidePhotoPreview()},1e3))}catch(t){console.error("[iPad] Failed to save to Supabase:",t),this.saveButton&&(this.saveButton.textContent="âœ—",setTimeout(()=>{this.saveButton.textContent="â†‘",this.saveButton.disabled=!1},2e3))}}downloadPhoto(t=null){const e=t||this.lastCapturedBlob;if(e){const s=URL.createObjectURL(e),a=document.createElement("a"),n=c();a.href=s,a.download=`ipad-snap-${n.type}-${Date.now()}.png`,a.style.display="none",document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(s),console.log(`[iPad] Photo downloaded locally: ${a.download}`)}}setupIPadGestures(){const t=this.outputContainer;if(!t)return;let e=0,s=!1;t.addEventListener("touchstart",a=>{if(a.preventDefault(),a.touches.length===1){const n=a.touches[0];e=Date.now(),n.clientX,n.clientY,s=!0}else s=!1},{passive:!1}),t.addEventListener("touchend",a=>{if(a.preventDefault(),!s||a.touches.length>0)return;Date.now()-e<200&&this.handleIPadDoubleTap()},{passive:!1}),t.addEventListener("click",a=>{a.target.closest("button")||this.handleIPadDoubleTap()}),t.addEventListener("gesturestart",a=>a.preventDefault()),t.addEventListener("gesturechange",a=>a.preventDefault()),t.addEventListener("gestureend",a=>a.preventDefault())}handleIPadDoubleTap(){const t=Date.now(),e=t-this.lastTap;this.tapTimeout&&(clearTimeout(this.tapTimeout),this.tapTimeout=null),e<400&&e>50?(console.log("[iPad] Double-tap detected - switching camera"),this.switchCamera(),this.lastTap=0):(this.lastTap=t,this.tapTimeout=setTimeout(()=>this.lastTap=0,400))}setupBackgroundAudio(){if(!this.backgroundAudio)return;this.backgroundAudio.volume=this.isIPadDevice?.3:.2,this.backgroundAudio.loop=!0;const t=async()=>{try{await this.backgroundAudio.play(),console.log("[iPad] Background audio started"),document.removeEventListener("touchstart",t),document.removeEventListener("click",t),document.removeEventListener("keydown",t)}catch(e){console.error("[iPad] Audio play failed:",e)}};document.addEventListener("touchstart",t,{once:!0}),document.addEventListener("click",t,{once:!0}),document.addEventListener("keydown",t,{once:!0}),this.backgroundAudio.play().catch(()=>{console.log("[iPad] Audio autoplay prevented - waiting for user interaction")})}destroy(){var t;console.log("[iPad] Destroying app..."),this.orientationHandler&&((t=screen.orientation)==null||t.removeEventListener("change",this.orientationHandler),window.removeEventListener("orientationchange",this.orientationHandler),window.removeEventListener("resize",this.orientationHandler)),this.orientationChangeTimeout&&clearTimeout(this.orientationChangeTimeout),this.tapTimeout&&clearTimeout(this.tapTimeout),this.mediaStream&&this.mediaStream.getTracks().forEach(e=>e.stop()),this.session&&this.session.destroy().catch(console.error),this.backgroundAudio&&(this.backgroundAudio.pause(),this.backgroundAudio.currentTime=0),console.log("[iPad] App destroyed")}}async function $(){try{window.bayouApp=new F,console.log("ðŸŽ® [iPad] Bayou AR App initialized with iPad optimizations + Remote API + Caching + Photo Capture")}catch(i){console.error("[iPad] Failed to start app:",i);const t=document.getElementById("app");t&&(t.style.color="#fff",t.style.display="grid",t.style.placeItems="center",t.textContent=`[iPad] App error: ${(i==null?void 0:i.message)||i}`)}}document.addEventListener("DOMContentLoaded",$);window.addEventListener("beforeunload",()=>{window.bayouApp&&window.bayouApp.destroy()});document.addEventListener("visibilitychange",()=>{window.bayouApp&&f&&(document.visibilityState==="visible"?console.log("[iPad] App became visible"):console.log("[iPad] App became hidden"))});console.log("ðŸš€ [iPad] iPad-Optimized Bayou AR script loaded (Remote API + Camera + Caching + Photo Capture + iPad Features)");
