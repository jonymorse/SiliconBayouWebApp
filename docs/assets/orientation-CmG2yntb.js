import"./modulepreload-polyfill-B5Qt9EMX.js";import{_ as w}from"./preload-helper-BNaQLqFv.js";import{b as f,C as c,a as y,r as C,c as d,T as S}from"./config-uyDoNbnC.js";const L="https://fwcdxvnpcpyxywbjwyaa.supabase.co",R="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3Y2R4dm5wY3B5eHl3Ymp3eWFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5OTg5NjMsImV4cCI6MjA3MzU3NDk2M30.XEfxRw39wp5jMs3YWFszhFZ1_ZXOilraSBN8R1e3LOI",b="gallerybucket";let h;const B=new TextEncoder,A=new TextDecoder,l=a=>B.encode(typeof a=="string"?a:JSON.stringify(a)),n=(...a)=>console.log("[RemoteAPI]",...a);let o={names:[],collected:{},t:Date.now()};const m="bayou_collected_items",u="reloadReason";function p(a){try{localStorage.setItem(m,JSON.stringify(a)),n("State saved to cache:",a)}catch(e){console.error("Failed to save state to cache:",e)}}function E(){try{const a=localStorage.getItem(m);if(a){const e=JSON.parse(a);return n("State loaded from cache:",e),e}}catch(a){console.error("Failed to load state from cache:",a)}return null}function O(){sessionStorage.setItem(u,"switchCamera"),n("Marked camera switch in session storage")}function T(){return sessionStorage.getItem(u)==="switchCamera"?(sessionStorage.removeItem(u),n("Detected camera switch reload"),!0):(n("Normal page load (not camera switch)"),!1)}function g(a){const e=Array.isArray(a==null?void 0:a.names)?a.names.map(String):[],t=a!=null&&a.collected&&typeof a.collected=="object"?a.collected:{},i={};e.forEach(r=>i[r]=t[r]===void 0?!0:!!t[r]),Object.keys(t).forEach(r=>{t[r]&&(i[r]=!0,e.includes(r)||e.push(r))});const s=Number.isFinite(a==null?void 0:a.t)?a.t:Date.now();return{names:e,collected:i,t:s}}let I=0;const k=()=>({apiSpecId:c.API_SPEC_ID,getRequestHandler(a){const e=(a==null?void 0:a.body)&&(a.body.byteLength??a.body.length)||0;if(n("REQ",`endpoint=${a.endpointId}`,`params=${JSON.stringify(a.parameters||{})}`,`body=${e}B`),a.endpointId==="ping"){const t=++I,i=performance.now();return s=>{s({status:"success",metadata:{n:String(t)},body:l({pong:!0,t:Date.now(),n:t})}),n("RES",`ping #${t}`,`${Math.round(performance.now()-i)}ms`)}}if(a.endpointId==="get_state"){const t=performance.now();return i=>{i({status:"success",metadata:{count:String(o.names.length)},body:l(o)}),n("RES","get_state",`${Math.round(performance.now()-t)}ms`,o)}}if(a.endpointId==="set_state"){const t=performance.now();return i=>{var s;try{let r=(s=a.parameters)==null?void 0:s.payload;if(r==null&&a.body&&(r=A.decode(a.body)),typeof r!="string"){i({status:"bad_request",metadata:{},body:l('missing or invalid "payload" (expected stringified JSON)')});return}const v=JSON.parse(r);o=g(v),p(o),i({status:"success",metadata:{count:String(o.names.length)},body:l({ok:!0})}),n("RES","set_state",`${Math.round(performance.now()-t)}ms`,"Updated gameState:",o)}catch(r){i({status:"server_error",metadata:{},body:l(String((r==null?void 0:r.message)||r))})}}}}});class P{constructor(e,t){this.session=e,this.cameraKit=t,this.currentOrientation="portrait",this.mediaStream=null,this.currentLens=null,this.worldTrackingActive=!1,this.resizeTimeout=null,this.handleOrientationChange=this.handleOrientationChange.bind(this),this.setupOrientationHandling()}setupOrientationHandling(){this.detectOrientation(),screen.orientation&&screen.orientation.addEventListener("change",this.handleOrientationChange),window.addEventListener("orientationchange",this.handleOrientationChange),window.addEventListener("resize",()=>{clearTimeout(this.resizeTimeout),this.resizeTimeout=setTimeout(this.handleOrientationChange,200)})}detectOrientation(){let e="portrait";if(screen.orientation)e=screen.orientation.type.includes("landscape")?"landscape":"portrait";else if(typeof window.orientation<"u"){const t=Math.abs(window.orientation);e=t===90||t===270?"landscape":"portrait"}else e=window.innerWidth/window.innerHeight>1?"landscape":"portrait";this.currentOrientation=e,console.log(`[RearCamera] Orientation: ${e}`),document.body.classList.remove("portrait-mode","landscape-mode"),document.body.classList.add(`${e}-mode`,"rear-camera-mode")}async handleOrientationChange(){const e=this.currentOrientation;this.detectOrientation(),e!==this.currentOrientation&&(console.log(`[RearCamera] Orientation changed: ${e} → ${this.currentOrientation}`),await this.restartRearCameraForOrientation())}async startRearCamera(){try{this.mediaStream&&this.mediaStream.getTracks().forEach(i=>i.stop());const e=this.getRearCameraConstraints();console.log(`[RearCamera] Starting camera for ${this.currentOrientation} mode`),this.mediaStream=await navigator.mediaDevices.getUserMedia(e);const t=d(this.mediaStream,{cameraType:"environment",fpsLimit:30});return await this.session.setSource(t),this.session.play("live"),console.log(`[RearCamera] Camera started successfully in ${this.currentOrientation} mode`),t}catch(e){console.error("[RearCamera] Camera start failed:",e),await this.tryFallbackRearCamera()}}getRearCameraConstraints(){const e={audio:!1,video:{facingMode:{exact:"environment"},frameRate:{ideal:30,max:30}}};return e.video.width={ideal:1280},e.video.height={ideal:720},console.log(`[RearCamera] Requesting standard landscape resolution: 1280x720 for ${this.currentOrientation} mode`),e}async restartRearCameraForOrientation(){if(this.session){console.log(`[RearCamera] Restarting for ${this.currentOrientation} orientation`);try{this.worldTrackingActive&&(await this.session.clearLens(),this.worldTrackingActive=!1,await new Promise(t=>setTimeout(t,300)));const e=await this.startRearCamera();await new Promise(t=>setTimeout(t,800)),this.currentLens&&(console.log("[RearCamera] Reapplying lens after orientation change"),await this.session.applyLens(this.currentLens),this.worldTrackingActive=!0),this.updateCanvasForOrientation()}catch(e){console.error("[RearCamera] Restart failed:",e)}}}async applyLens(e){try{this.currentLens=e,await this.session.applyLens(e),this.worldTrackingActive=!0,console.log(`[RearCamera] Lens applied in ${this.currentOrientation} mode`)}catch(t){console.error("[RearCamera] Lens application failed:",t),this.currentLens=null,this.worldTrackingActive=!1}}async clearLens(){try{await this.session.clearLens(),this.currentLens=null,this.worldTrackingActive=!1,console.log("[RearCamera] Lens cleared")}catch(e){console.error("[RearCamera] Lens clear failed:",e)}}updateCanvasForOrientation(){var t,i;const e=(i=(t=this.session)==null?void 0:t.output)==null?void 0:i.live;e&&setTimeout(()=>{const s=e.getBoundingClientRect(),r=Math.min(window.devicePixelRatio||1,2);e.width=Math.round(s.width*r),e.height=Math.round(s.height*r),console.log(`[RearCamera] Canvas updated: ${e.width}x${e.height} for ${this.currentOrientation}`)},100)}async tryFallbackRearCamera(){try{console.log("[RearCamera] Trying fallback constraints...");const e={audio:!1,video:{facingMode:{ideal:"environment"}}};this.mediaStream&&this.mediaStream.getTracks().forEach(i=>i.stop()),this.mediaStream=await navigator.mediaDevices.getUserMedia(e);const t=d(this.mediaStream,{cameraType:"environment"});await this.session.setSource(t),this.session.play("live"),console.log("[RearCamera] Fallback camera successful")}catch(e){console.error("[RearCamera] Fallback camera failed:",e)}}destroy(){screen.orientation&&screen.orientation.removeEventListener("change",this.handleOrientationChange),window.removeEventListener("orientationchange",this.handleOrientationChange),clearTimeout(this.resizeTimeout),this.mediaStream&&this.mediaStream.getTracks().forEach(e=>e.stop())}}class M{constructor(){this.outputContainer=document.getElementById("app"),this.captureButton=document.getElementById("captureButton"),this.photoPreview=document.getElementById("photoPreview"),this.previewImage=document.getElementById("previewImage"),this.retakeButton=document.getElementById("retakeButton"),this.saveButton=document.getElementById("saveButton"),this.lastCapturedBlob=null,this.cameraKit=null,this.session=null,this.rearCameraManager=null,this.lensActive=!1,this.currentLens=null,this.currentFacingMode="environment",this.lastTap=0,this.tapTimeout=null,this.backgroundAudio=document.getElementById("backgroundAudio"),this.liveCanvas=null,this.initializeApp()}async initializeApp(){if(T()){const e=E();e&&(o=g(e),n("Restored state from cache after camera switch:",o))}else localStorage.removeItem(m),n("Manual refresh detected - cache cleared, starting fresh");await this.initializeSupabase(),this.setupCaptureButton(),this.setupPreviewControls(),this.setupDoubleTapGesture(),this.setupBackgroundAudio(),await this.initializeCameraKit(),await this.autoStartWithLens()}async initializeSupabase(){try{const{createClient:e}=await w(async()=>{const{createClient:t}=await import("https://esm.sh/@supabase/supabase-js@2");return{createClient:t}},[]);h=e(L,R),console.log("● Supabase initialized successfully")}catch(e){console.error("■ Supabase initialization failed:",e)}}setupCaptureButton(){this.captureButton&&this.captureButton.addEventListener("click",()=>{this.photoPreview&&this.photoPreview.classList.contains("show")?this.hidePhotoPreview():this.capturePhoto()})}setupPreviewControls(){this.retakeButton&&this.retakeButton.addEventListener("click",()=>{this.hidePhotoPreview()}),this.saveButton&&this.saveButton.addEventListener("click",()=>{this.saveToSupabase()})}async initializeCameraKit(){try{this.cameraKit=await f({apiToken:c.API_TOKEN,logger:"console"},s=>s.provides(y(C.token,()=>k()))),console.info("[RemoteAPI] provider registered for spec:",c.API_SPEC_ID),this.session=await this.cameraKit.createSession(),window.ckSession=this.session,this.session.events.addEventListener("error",s=>{console.error("Camera Kit error:",s.detail)}),this.rearCameraManager=new P(this.session,this.cameraKit),this.liveCanvas=this.session.output.live,this.outputContainer.appendChild(this.liveCanvas),this.liveCanvas.style.width="100%",this.liveCanvas.style.height="100%",this.liveCanvas.style.objectFit="cover",this.liveCanvas.style.display="block",this.liveCanvas.style.background="#000";const t=/iPad|iPhone|iPod/.test(navigator.userAgent)||/Macintosh/.test(navigator.userAgent)&&"ontouchend"in document?1:Math.min(window.devicePixelRatio||1,2),i=()=>{const s=this.liveCanvas.getBoundingClientRect();this.liveCanvas.width=Math.round(s.width*t),this.liveCanvas.height=Math.round(s.height*t),console.log(`Canvas sized: ${this.liveCanvas.width}x${this.liveCanvas.height}`)};new ResizeObserver(i).observe(this.liveCanvas.parentElement),window.addEventListener("orientationchange",i),window.addEventListener("load",i),i()}catch(e){console.error("Failed to initialize Camera Kit:",e)}}async autoStartWithLens(){try{await this.rearCameraManager.startRearCamera(),await new Promise(t=>setTimeout(t,1e3));const e=await this.cameraKit.lensRepository.loadLens(c.LENS_ID,c.LENS_GROUP_ID);await this.rearCameraManager.applyLens(e),this.currentLens=e,this.lensActive=!0}catch(e){console.error("[BayouAR] Auto-start failed:",e)}}async toggleLens(){if(this.rearCameraManager)try{if(this.lensActive&&this.currentLens)await this.rearCameraManager.clearLens(),this.lensActive=!1,this.currentLens=null;else{const e=await this.cameraKit.lensRepository.loadLens(c.LENS_ID,c.LENS_GROUP_ID);await this.rearCameraManager.applyLens(e),this.currentLens=e,this.lensActive=!0}}catch(e){console.error("[BayouAR] Lens toggle failed:",e),this.lensActive=!1,this.currentLens=null}}async switchCamera(){if(this.session)try{const e=this.currentFacingMode==="user"?"environment":"user";if(this.currentFacingMode==="user"&&e==="environment"){n("Switching from front to back camera - reloading page"),O(),p(o),this.rearCameraManager&&this.rearCameraManager.mediaStream&&this.rearCameraManager.mediaStream.getTracks().forEach(t=>t.stop()),window.location.reload();return}this.currentFacingMode==="environment"&&e==="user"&&(n("Switching from back to front camera - smooth switch"),this.rearCameraManager&&(this.rearCameraManager.destroy(),this.rearCameraManager=null),this.currentFacingMode=e,await this.startFrontCamera(),this.lensActive&&this.currentLens&&await this.session.applyLens(this.currentLens))}catch(e){console.error("[BayouAR] Camera switch failed:",e)}}async startFrontCamera(){try{const e=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:"user"},frameRate:{ideal:30}},audio:!1}),t=d(e,{cameraType:"user"});await this.session.setSource(t),t.setTransform(S.MirrorX),this.session.play("live"),console.log("Front camera started successfully")}catch(e){console.error("Front camera start failed:",e)}}capturePhoto(){if(!this.session||!this.liveCanvas){console.error("Camera session not ready for capture");return}try{const e=document.createElement("canvas"),t=e.getContext("2d");e.width=this.liveCanvas.width,e.height=this.liveCanvas.height,t.drawImage(this.liveCanvas,0,0),e.toBlob(i=>{if(i){this.lastCapturedBlob=i;const s=URL.createObjectURL(i);this.previewImage&&this.photoPreview?(this.previewImage.src=s,this.showPhotoPreview()):this.downloadPhoto(i),console.log("● Photo captured!"),this.captureButton&&(this.captureButton.style.transform="scale(0.95)",setTimeout(()=>{this.captureButton.style.transform=""},150))}},"image/png")}catch(e){console.error("Photo capture failed:",e)}}showPhotoPreview(){this.photoPreview&&(this.photoPreview.classList.add("show"),this.captureButton&&(this.captureButton.style.opacity="0.8"))}hidePhotoPreview(){this.photoPreview&&this.photoPreview.classList.remove("show"),this.captureButton&&(this.captureButton.style.opacity="1"),this.saveButton&&(this.saveButton.textContent="○",this.saveButton.disabled=!1),this.previewImage&&this.previewImage.src&&(URL.revokeObjectURL(this.previewImage.src),this.previewImage.src=""),this.lastCapturedBlob=null}async saveToSupabase(){if(!this.lastCapturedBlob||!h){console.error("Cannot save: Missing photo data or Supabase not initialized");return}try{this.saveButton&&(this.saveButton.textContent="●●●",this.saveButton.disabled=!0);const t=`snap-capture-${Date.now()}.png`;console.log("↑ Uploading photo to Supabase...");const{data:i,error:s}=await h.storage.from(b).upload(t,this.lastCapturedBlob,{contentType:"image/png"});if(s)throw s;console.log("● Photo saved to Supabase:",t),this.saveButton&&(this.saveButton.textContent="●",setTimeout(()=>{this.hidePhotoPreview()},1e3))}catch(e){console.error("■ Failed to save to Supabase:",e),this.saveButton&&(this.saveButton.textContent="■",setTimeout(()=>{this.saveButton.textContent="↑",this.saveButton.disabled=!1},2e3))}}downloadPhoto(e=null){const t=e||this.lastCapturedBlob;if(t){const i=URL.createObjectURL(t),s=document.createElement("a");s.href=i,s.download=`snap-capture-${Date.now()}.png`,s.style.display="none",document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(i),console.log("💾 Photo downloaded locally!")}}setupDoubleTapGesture(){const e=this.outputContainer;e.addEventListener("touchend",t=>{t.preventDefault(),this.handleDoubleTap()}),e.addEventListener("click",t=>{t.target.closest("button")||this.handleDoubleTap()})}setupBackgroundAudio(){if(!this.backgroundAudio)return;this.backgroundAudio.volume=.2,this.backgroundAudio.loop=!0;const e=async()=>{try{await this.backgroundAudio.play(),console.log("● Background audio started"),document.removeEventListener("touchstart",e),document.removeEventListener("click",e),document.removeEventListener("keydown",e)}catch(t){console.error("■ Audio play failed:",t)}};document.addEventListener("touchstart",e,{once:!0}),document.addEventListener("click",e,{once:!0}),document.addEventListener("keydown",e,{once:!0}),this.backgroundAudio.play().catch(()=>{console.log("Audio autoplay prevented - waiting for user interaction")})}handleDoubleTap(){const e=Date.now(),t=e-this.lastTap;this.tapTimeout&&(clearTimeout(this.tapTimeout),this.tapTimeout=null),t<300&&t>0?(this.switchCamera(),this.lastTap=0):(this.lastTap=e,this.tapTimeout=setTimeout(()=>this.lastTap=0,300))}destroy(){this.rearCameraManager&&this.rearCameraManager.destroy(),this.session&&this.session.destroy().catch(console.error),this.backgroundAudio&&(this.backgroundAudio.pause(),this.backgroundAudio.currentTime=0)}}async function F(){try{window.bayouApp=new M,console.log("🎮 Bayou AR App initialized with Rear Camera Orientation Support")}catch(a){console.error("Failed to start app:",a);const e=document.getElementById("app");e&&(e.style.color="#fff",e.style.display="grid",e.style.placeItems="center",e.textContent=`App error: ${(a==null?void 0:a.message)||a}`)}}document.addEventListener("DOMContentLoaded",F);window.addEventListener("beforeunload",()=>{window.bayouApp&&window.bayouApp.destroy()});console.log("🚀 Unified Bayou AR script loaded with Rear Camera Orientation Support");
