import"./modulepreload-polyfill-B5Qt9EMX.js";import{b as L,C as m,a as A,r as P,c as w,T as y}from"./config-DGZoT654.js";const k="modulepreload",T=function(e){return"/SiliconBayouWebApp/"+e},C={},R=function(t,a,i){let s=Promise.resolve();if(a&&a.length>0){document.getElementsByTagName("link");const n=document.querySelector("meta[property=csp-nonce]"),l=(n==null?void 0:n.nonce)||(n==null?void 0:n.getAttribute("nonce"));s=Promise.allSettled(a.map(d=>{if(d=T(d),d in C)return;C[d]=!0;const p=d.endsWith(".css"),B=p?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${d}"]${B}`))return;const h=document.createElement("link");if(h.rel=p?"stylesheet":k,p||(h.as="script"),h.crossOrigin="",h.href=d,l&&h.setAttribute("nonce",l),document.head.appendChild(h),p)return new Promise((E,I)=>{h.addEventListener("load",E),h.addEventListener("error",()=>I(new Error(`Unable to preload CSS for ${d}`)))})}))}function o(n){const l=new Event("vite:preloadError",{cancelable:!0});if(l.payload=n,window.dispatchEvent(l),!l.defaultPrevented)throw n}return s.then(n=>{for(const l of n||[])l.status==="rejected"&&o(l.reason);return t().catch(o)})},M="https://fwcdxvnpcpyxywbjwyaa.supabase.co",F="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3Y2R4dm5wY3B5eHl3Ymp3eWFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5OTg5NjMsImV4cCI6MjA3MzU3NDk2M30.XEfxRw39wp5jMs3YWFszhFZ1_ZXOilraSBN8R1e3LOI",O="gallerybucket";let v;const _=new TextEncoder,D=new TextDecoder,u=e=>_.encode(typeof e=="string"?e:JSON.stringify(e)),r=(...e)=>console.log("[RemoteAPI]",...e);let c={names:[],collected:{},t:Date.now()};const f="bayou_collected_items",g="reloadReason";function S(e){try{localStorage.setItem(f,JSON.stringify(e)),r("State saved to cache:",e)}catch(t){console.error("Failed to save state to cache:",t)}}function U(){try{const e=localStorage.getItem(f);if(e){const t=JSON.parse(e);return r("State loaded from cache:",t),t}}catch(e){console.error("Failed to load state from cache:",e)}return null}function z(){sessionStorage.setItem(g,"switchCamera"),r("Marked camera switch in session storage")}function N(){return sessionStorage.getItem(g)==="switchCamera"?(sessionStorage.removeItem(g),r("Detected camera switch reload"),!0):(r("Normal page load (not camera switch)"),!1)}function b(e){const t=Array.isArray(e==null?void 0:e.names)?e.names.map(String):[],a=e!=null&&e.collected&&typeof e.collected=="object"?e.collected:{},i={};t.forEach(o=>i[o]=a[o]===void 0?!0:!!a[o]),Object.keys(a).forEach(o=>{a[o]&&(i[o]=!0,t.includes(o)||t.push(o))});const s=Number.isFinite(e==null?void 0:e.t)?e.t:Date.now();return{names:t,collected:i,t:s}}let x=0;const $=()=>({apiSpecId:m.API_SPEC_ID,getRequestHandler(e){const t=(e==null?void 0:e.body)&&(e.body.byteLength??e.body.length)||0;if(r("REQ",`endpoint=${e.endpointId}`,`params=${JSON.stringify(e.parameters||{})}`,`body=${t}B`),e.endpointId==="ping"){const a=++x,i=performance.now();return s=>{s({status:"success",metadata:{n:String(a)},body:u({pong:!0,t:Date.now(),n:a})}),r("RES",`ping #${a}`,`${Math.round(performance.now()-i)}ms`)}}if(e.endpointId==="get_state"){const a=performance.now();return i=>{i({status:"success",metadata:{count:String(c.names.length)},body:u(c)}),r("RES","get_state",`${Math.round(performance.now()-a)}ms`,c)}}if(e.endpointId==="set_state"){const a=performance.now();return i=>{var s;try{let o=(s=e.parameters)==null?void 0:s.payload;if(o==null&&e.body&&(o=D.decode(e.body)),typeof o!="string"){i({status:"bad_request",metadata:{},body:u('missing or invalid "payload" (expected stringified JSON)')});return}const n=JSON.parse(o);c=b(n),S(c),i({status:"success",metadata:{count:String(c.names.length)},body:u({ok:!0})}),r("RES","set_state",`${Math.round(performance.now()-a)}ms`,"Updated gameState:",c)}catch(o){i({status:"server_error",metadata:{},body:u(String((o==null?void 0:o.message)||o))})}}}}});class K{constructor(){this.outputContainer=document.getElementById("app"),this.captureButton=document.getElementById("captureButton"),this.photoPreview=document.getElementById("photoPreview"),this.previewImage=document.getElementById("previewImage"),this.retakeButton=document.getElementById("retakeButton"),this.saveButton=document.getElementById("saveButton"),this.lastCapturedBlob=null,this.cameraKit=null,this.session=null,this.mediaStream=null,this.lensActive=!1,this.currentLens=null,this.currentFacingMode="environment",this.lastTap=0,this.tapTimeout=null,this.backgroundAudio=document.getElementById("backgroundAudio"),this.liveCanvas=null,this.initializeApp()}async initializeApp(){if(N()){const t=U();t&&(c=b(t),r("Restored state from cache after camera switch:",c))}else localStorage.removeItem(f),r("Manual refresh detected - cache cleared, starting fresh");await this.initializeSupabase(),this.setupCaptureButton(),this.setupPreviewControls(),this.setupDoubleTapGesture(),this.setupBackgroundAudio(),await this.initializeCameraKit(),await this.autoStartWithLens()}async initializeSupabase(){try{const{createClient:t}=await R(async()=>{const{createClient:a}=await import("https://esm.sh/@supabase/supabase-js@2");return{createClient:a}},[]);v=t(M,F),console.log("â— Supabase initialized successfully")}catch(t){console.error("â–  Supabase initialization failed:",t)}}setupCaptureButton(){this.captureButton&&this.captureButton.addEventListener("click",()=>{this.photoPreview&&this.photoPreview.classList.contains("show")?this.hidePhotoPreview():this.capturePhoto()})}setupPreviewControls(){this.retakeButton&&this.retakeButton.addEventListener("click",()=>{this.hidePhotoPreview()}),this.saveButton&&this.saveButton.addEventListener("click",()=>{this.saveToSupabase()})}async initializeCameraKit(){try{this.cameraKit=await L({apiToken:m.API_TOKEN,logger:"console"},s=>s.provides(A(P.token,()=>$()))),console.info("[RemoteAPI] provider registered for spec:",m.API_SPEC_ID),this.session=await this.cameraKit.createSession(),window.ckSession=this.session,this.session.events.addEventListener("error",s=>{console.error("Camera Kit error:",s.detail)}),this.liveCanvas=this.session.output.live,this.outputContainer.appendChild(this.liveCanvas),this.liveCanvas.style.width="100%",this.liveCanvas.style.height="100%",this.liveCanvas.style.objectFit="cover",this.liveCanvas.style.display="block",this.liveCanvas.style.background="#000";const a=/iPad|iPhone|iPod/.test(navigator.userAgent)||/Macintosh/.test(navigator.userAgent)&&"ontouchend"in document?1:Math.min(window.devicePixelRatio||1,2),i=()=>{const s=this.liveCanvas.getBoundingClientRect();this.liveCanvas.width=Math.round(s.width*a),this.liveCanvas.height=Math.round(s.height*a),console.log(`Canvas sized: ${this.liveCanvas.width}x${this.liveCanvas.height}`)};new ResizeObserver(i).observe(this.liveCanvas.parentElement),window.addEventListener("orientationchange",i),window.addEventListener("load",i),i()}catch(t){console.error("Failed to initialize Camera Kit:",t)}}async startCamera(){try{this.mediaStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:this.currentFacingMode},frameRate:{ideal:30}},audio:!1});const t=w(this.mediaStream);await this.session.setSource(t),this.currentFacingMode==="user"&&t.setTransform(y.MirrorX),this.session.play("live")}catch(t){console.error("Camera failed:",t),t.name==="OverconstrainedError"&&await this.tryFallbackCamera()}}async tryFallbackCamera(){try{this.mediaStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:this.currentFacingMode}});const t=w(this.mediaStream);await this.session.setSource(t),this.currentFacingMode==="user"&&t.setTransform(y.MirrorX),this.session.play("live")}catch(t){console.error("Fallback camera failed:",t)}}async switchCamera(){if(this.session)try{const t=this.currentFacingMode==="user"?"environment":"user";if(this.currentFacingMode==="user"&&t==="environment"){r("Switching from front to back camera - reloading page"),z(),S(c),this.mediaStream&&this.mediaStream.getTracks().forEach(a=>a.stop()),window.location.reload();return}r("Switching from back to front camera - smooth switch"),this.mediaStream&&this.mediaStream.getTracks().forEach(a=>a.stop()),this.currentFacingMode=t,await this.startCamera(),this.lensActive&&this.currentLens&&await this.session.applyLens(this.currentLens),console.log(`Camera switched to: ${this.currentFacingMode}`)}catch(t){console.error("Switch failed:",t),this.currentFacingMode==="environment"&&(this.currentFacingMode="user")}}async toggleLens(){if(this.session)try{this.lensActive&&this.currentLens?(await this.session.clearLens(),this.lensActive=!1,this.currentLens=null):(this.currentLens=await this.cameraKit.lensRepository.loadLens(m.LENS_ID,m.LENS_GROUP_ID),await this.session.applyLens(this.currentLens),this.lensActive=!0)}catch(t){console.error("Lens error:",t),this.lensActive=!1,this.currentLens=null}}async autoStartWithLens(){try{await this.startCamera(),await new Promise(t=>setTimeout(t,1e3)),await this.toggleLens()}catch(t){console.error("Auto-start failed:",t)}}capturePhoto(){if(!this.session||!this.liveCanvas){console.error("Camera session not ready for capture");return}try{const t=document.createElement("canvas"),a=t.getContext("2d");t.width=this.liveCanvas.width,t.height=this.liveCanvas.height,a.drawImage(this.liveCanvas,0,0),t.toBlob(i=>{if(i){this.lastCapturedBlob=i;const s=URL.createObjectURL(i);this.previewImage&&this.photoPreview?(this.previewImage.src=s,this.showPhotoPreview()):this.downloadPhoto(i),console.log("â— Photo captured!"),this.captureButton&&(this.captureButton.style.transform="scale(0.95)",setTimeout(()=>{this.captureButton.style.transform=""},150))}},"image/png")}catch(t){console.error("Photo capture failed:",t)}}showPhotoPreview(){this.photoPreview&&(this.photoPreview.classList.add("show"),this.captureButton&&(this.captureButton.style.opacity="0.8"))}hidePhotoPreview(){this.photoPreview&&this.photoPreview.classList.remove("show"),this.captureButton&&(this.captureButton.style.opacity="1"),this.saveButton&&(this.saveButton.textContent="â—‹",this.saveButton.disabled=!1),this.previewImage&&this.previewImage.src&&(URL.revokeObjectURL(this.previewImage.src),this.previewImage.src=""),this.lastCapturedBlob=null}async saveToSupabase(){if(!this.lastCapturedBlob||!v){console.error("Cannot save: Missing photo data or Supabase not initialized");return}try{this.saveButton&&(this.saveButton.textContent="â—â—â—",this.saveButton.disabled=!0);const a=`snap-capture-${Date.now()}.png`;console.log("â†‘ Uploading photo to Supabase...");const{data:i,error:s}=await v.storage.from(O).upload(a,this.lastCapturedBlob,{contentType:"image/png"});if(s)throw s;console.log("â— Photo saved to Supabase:",a),this.saveButton&&(this.saveButton.textContent="â—",setTimeout(()=>{this.hidePhotoPreview()},1e3))}catch(t){console.error("â–  Failed to save to Supabase:",t),this.saveButton&&(this.saveButton.textContent="â– ",setTimeout(()=>{this.saveButton.textContent="â†‘",this.saveButton.disabled=!1},2e3))}}downloadPhoto(t=null){const a=t||this.lastCapturedBlob;if(a){const i=URL.createObjectURL(a),s=document.createElement("a");s.href=i,s.download=`snap-capture-${Date.now()}.png`,s.style.display="none",document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(i),console.log("ðŸ’¾ Photo downloaded locally!")}}setupDoubleTapGesture(){const t=this.outputContainer;t.addEventListener("touchend",a=>{a.preventDefault(),this.handleDoubleTap()}),t.addEventListener("click",a=>{a.target.closest("button")||this.handleDoubleTap()})}setupBackgroundAudio(){if(!this.backgroundAudio)return;this.backgroundAudio.volume=.2,this.backgroundAudio.loop=!0;const t=async()=>{try{await this.backgroundAudio.play(),console.log("â— Background audio started"),document.removeEventListener("touchstart",t),document.removeEventListener("click",t),document.removeEventListener("keydown",t)}catch(a){console.error("â–  Audio play failed:",a)}};document.addEventListener("touchstart",t,{once:!0}),document.addEventListener("click",t,{once:!0}),document.addEventListener("keydown",t,{once:!0}),this.backgroundAudio.play().catch(()=>{console.log("Audio autoplay prevented - waiting for user interaction")})}handleDoubleTap(){const t=Date.now(),a=t-this.lastTap;this.tapTimeout&&(clearTimeout(this.tapTimeout),this.tapTimeout=null),a<300&&a>0?(this.switchCamera(),this.lastTap=0):(this.lastTap=t,this.tapTimeout=setTimeout(()=>this.lastTap=0,300))}destroy(){this.mediaStream&&this.mediaStream.getTracks().forEach(t=>t.stop()),this.session&&this.session.destroy().catch(console.error),this.backgroundAudio&&(this.backgroundAudio.pause(),this.backgroundAudio.currentTime=0)}}async function J(){try{window.bayouApp=new K,console.log("ðŸŽ® Bayou AR App initialized with Remote API + Caching + Photo Capture")}catch(e){console.error("Failed to start app:",e);const t=document.getElementById("app");t&&(t.style.color="#fff",t.style.display="grid",t.style.placeItems="center",t.textContent=`App error: ${(e==null?void 0:e.message)||e}`)}}document.addEventListener("DOMContentLoaded",J);window.addEventListener("beforeunload",()=>{window.bayouApp&&window.bayouApp.destroy()});console.log("ðŸš€ Unified Bayou AR script loaded (Remote API + Camera + Caching + Photo Capture)");
