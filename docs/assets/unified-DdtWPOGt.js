import"./modulepreload-polyfill-B5Qt9EMX.js";import{b as v,C as d,a as y,r as w,c as u,T as m}from"./config-CNwrM9qc.js";const S=new TextEncoder,A=new TextDecoder,c=t=>S.encode(typeof t=="string"?t:JSON.stringify(t)),n=(...t)=>console.log("[RemoteAPI]",...t);let r={names:[],collected:{},t:Date.now()};const h="bayou_collected_items",l="reloadReason";function g(t){try{localStorage.setItem(h,JSON.stringify(t)),n("State saved to cache:",t)}catch(e){console.error("Failed to save state to cache:",e)}}function C(){try{const t=localStorage.getItem(h);if(t){const e=JSON.parse(t);return n("State loaded from cache:",e),e}}catch(t){console.error("Failed to load state from cache:",t)}return null}function E(){sessionStorage.setItem(l,"switchCamera"),n("Marked camera switch in session storage")}function L(){return sessionStorage.getItem(l)==="switchCamera"?(sessionStorage.removeItem(l),n("Detected camera switch reload"),!0):(n("Normal page load (not camera switch)"),!1)}function p(t){const e=Array.isArray(t==null?void 0:t.names)?t.names.map(String):[],a=t!=null&&t.collected&&typeof t.collected=="object"?t.collected:{},s={};e.forEach(i=>s[i]=a[i]===void 0?!0:!!a[i]),Object.keys(a).forEach(i=>{a[i]&&(s[i]=!0,e.includes(i)||e.push(i))});const o=Number.isFinite(t==null?void 0:t.t)?t.t:Date.now();return{names:e,collected:s,t:o}}let b=0;const k=()=>({apiSpecId:d.API_SPEC_ID,getRequestHandler(t){const e=(t==null?void 0:t.body)&&(t.body.byteLength??t.body.length)||0;if(n("REQ",`endpoint=${t.endpointId}`,`params=${JSON.stringify(t.parameters||{})}`,`body=${e}B`),t.endpointId==="ping"){const a=++b,s=performance.now();return o=>{o({status:"success",metadata:{n:String(a)},body:c({pong:!0,t:Date.now(),n:a})}),n("RES",`ping #${a}`,`${Math.round(performance.now()-s)}ms`)}}if(t.endpointId==="get_state"){const a=performance.now();return s=>{s({status:"success",metadata:{count:String(r.names.length)},body:c(r)}),n("RES","get_state",`${Math.round(performance.now()-a)}ms`,r)}}if(t.endpointId==="set_state"){const a=performance.now();return s=>{var o;try{let i=(o=t.parameters)==null?void 0:o.payload;if(i==null&&t.body&&(i=A.decode(t.body)),typeof i!="string"){s({status:"bad_request",metadata:{},body:c('missing or invalid "payload" (expected stringified JSON)')});return}const f=JSON.parse(i);r=p(f),g(r),s({status:"success",metadata:{count:String(r.names.length)},body:c({ok:!0})}),n("RES","set_state",`${Math.round(performance.now()-a)}ms`,"Updated gameState:",r)}catch(i){s({status:"server_error",metadata:{},body:c(String((i==null?void 0:i.message)||i))})}}}}});class T{constructor(){this.outputContainer=document.getElementById("app"),this.cameraKit=null,this.session=null,this.mediaStream=null,this.lensActive=!1,this.currentLens=null,this.currentFacingMode="environment",this.lastTap=0,this.tapTimeout=null,this.backgroundAudio=document.getElementById("backgroundAudio"),this.liveCanvas=null,this.initializeApp()}async initializeApp(){if(L()){const e=C();e&&(r=p(e),n("Restored state from cache after camera switch:",r))}else localStorage.removeItem(h),n("Manual refresh detected - cache cleared, starting fresh");this.setupDoubleTapGesture(),this.setupBackgroundAudio(),await this.initializeCameraKit(),await this.autoStartWithLens()}async initializeCameraKit(){try{this.cameraKit=await v({apiToken:d.API_TOKEN,logger:"console"},o=>o.provides(y(w.token,()=>k()))),console.info("[RemoteAPI] provider registered for spec:",d.API_SPEC_ID),this.session=await this.cameraKit.createSession(),window.ckSession=this.session,this.session.events.addEventListener("error",o=>{console.error("Camera Kit error:",o.detail)}),this.liveCanvas=this.session.output.live,this.outputContainer.appendChild(this.liveCanvas),this.liveCanvas.style.width="100%",this.liveCanvas.style.height="100%",this.liveCanvas.style.objectFit="cover",this.liveCanvas.style.display="block",this.liveCanvas.style.background="#000";const a=/iPad|iPhone|iPod/.test(navigator.userAgent)||/Macintosh/.test(navigator.userAgent)&&"ontouchend"in document?1:Math.min(window.devicePixelRatio||1,2),s=()=>{const o=this.liveCanvas.getBoundingClientRect();this.liveCanvas.width=Math.round(o.width*a),this.liveCanvas.height=Math.round(o.height*a),console.log(`Canvas sized: ${this.liveCanvas.width}x${this.liveCanvas.height} (CSS: ${o.width}x${o.height}, DPR: ${a})`)};new ResizeObserver(s).observe(this.liveCanvas.parentElement),window.addEventListener("orientationchange",s),window.addEventListener("load",s),s()}catch(e){console.error("Failed to initialize Camera Kit:",e)}}async startCamera(){try{this.mediaStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:this.currentFacingMode},frameRate:{ideal:30}},audio:!1});const e=u(this.mediaStream);await this.session.setSource(e),this.currentFacingMode==="user"&&e.setTransform(m.MirrorX),this.session.play("live")}catch(e){console.error("Camera failed:",e),e.name==="OverconstrainedError"&&await this.tryFallbackCamera()}}async tryFallbackCamera(){try{this.mediaStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:this.currentFacingMode}});const e=u(this.mediaStream);await this.session.setSource(e),this.currentFacingMode==="user"&&e.setTransform(m.MirrorX),this.session.play("live")}catch(e){console.error("Fallback camera failed:",e)}}async switchCamera(){if(this.session)try{const e=this.currentFacingMode==="user"?"environment":"user";if(this.currentFacingMode==="user"&&e==="environment"){n("Switching from front to back camera - reloading page"),E(),g(r),this.mediaStream&&this.mediaStream.getTracks().forEach(a=>a.stop()),window.location.reload();return}n("Switching from back to front camera - smooth switch"),this.mediaStream&&this.mediaStream.getTracks().forEach(a=>a.stop()),this.currentFacingMode=e,await this.startCamera(),this.lensActive&&this.currentLens&&await this.session.applyLens(this.currentLens),console.log(`Camera switched to: ${this.currentFacingMode}`)}catch(e){console.error("Switch failed:",e),this.currentFacingMode==="environment"&&(this.currentFacingMode="user")}}async toggleLens(){if(this.session)try{this.lensActive&&this.currentLens?(await this.session.clearLens(),this.lensActive=!1,this.currentLens=null):(this.currentLens=await this.cameraKit.lensRepository.loadLens(d.LENS_ID,d.LENS_GROUP_ID),await this.session.applyLens(this.currentLens),this.lensActive=!0)}catch(e){console.error("Lens error:",e),this.lensActive=!1,this.currentLens=null}}async autoStartWithLens(){try{await this.startCamera(),await new Promise(e=>setTimeout(e,1e3)),await this.toggleLens()}catch(e){console.error("Auto-start failed:",e)}}setupDoubleTapGesture(){const e=this.outputContainer;e.addEventListener("touchend",a=>{a.preventDefault(),this.handleDoubleTap()}),e.addEventListener("click",a=>{a.target.closest("button")||this.handleDoubleTap()})}setupBackgroundAudio(){if(!this.backgroundAudio){console.log("No background audio element found");return}this.backgroundAudio.volume=.2,this.backgroundAudio.loop=!0,this.backgroundAudio.addEventListener("canplay",()=>console.log("Audio ready")),this.backgroundAudio.addEventListener("error",a=>{console.error("Audio error:",a.target.error)});const e=async()=>{try{await this.backgroundAudio.play(),console.log("✅ Background audio started"),document.removeEventListener("touchstart",e),document.removeEventListener("click",e),document.removeEventListener("keydown",e)}catch(a){console.error("❌ Audio play failed:",a)}};document.addEventListener("touchstart",e,{once:!0}),document.addEventListener("click",e,{once:!0}),document.addEventListener("keydown",e,{once:!0}),this.backgroundAudio.play().catch(()=>{console.log("Audio autoplay prevented - waiting for user interaction")})}handleDoubleTap(){const e=Date.now(),a=e-this.lastTap;this.tapTimeout&&(clearTimeout(this.tapTimeout),this.tapTimeout=null),a<300&&a>0?(this.switchCamera(),this.lastTap=0):(this.lastTap=e,this.tapTimeout=setTimeout(()=>this.lastTap=0,300))}updateStatus(e){console.log(`[BayouAR] ${e}`)}destroy(){this.mediaStream&&this.mediaStream.getTracks().forEach(e=>e.stop()),this.session&&this.session.destroy().catch(console.error),this.backgroundAudio&&(this.backgroundAudio.pause(),this.backgroundAudio.currentTime=0)}}async function I(){try{window.bayouApp=new T,console.log("🎮 Bayou AR App initialized with Remote API + Caching")}catch(t){console.error("Failed to start app:",t);const e=document.getElementById("app");e&&(e.style.color="#fff",e.style.display="grid",e.style.placeItems="center",e.textContent=`App error: ${(t==null?void 0:t.message)||t}`)}}document.addEventListener("DOMContentLoaded",I);window.addEventListener("beforeunload",()=>{window.bayouApp&&window.bayouApp.destroy()});console.log("🚀 Unified Bayou AR script loaded (Remote API + Camera + Caching)");
