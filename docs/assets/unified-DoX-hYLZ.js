import"./modulepreload-polyfill-B5Qt9EMX.js";import{_ as w}from"./preload-helper-BNaQLqFv.js";import{b as y,C as d,a as C,r as S,c as p,T as m}from"./config-uyDoNbnC.js";const B="https://fwcdxvnpcpyxywbjwyaa.supabase.co",b="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ3Y2R4dm5wY3B5eHl3Ymp3eWFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc5OTg5NjMsImV4cCI6MjA3MzU3NDk2M30.XEfxRw39wp5jMs3YWFszhFZ1_ZXOilraSBN8R1e3LOI",I="gallerybucket";let l;const E=new TextEncoder,L=new TextDecoder,c=e=>E.encode(typeof e=="string"?e:JSON.stringify(e)),n=(...e)=>console.log("[RemoteAPI]",...e);let r={names:[],collected:{},t:Date.now()};const u="bayou_collected_items",h="reloadReason";function v(e){try{localStorage.setItem(u,JSON.stringify(e)),n("State saved to cache:",e)}catch(t){console.error("Failed to save state to cache:",t)}}function A(){try{const e=localStorage.getItem(u);if(e){const t=JSON.parse(e);return n("State loaded from cache:",t),t}}catch(e){console.error("Failed to load state from cache:",e)}return null}function P(){sessionStorage.setItem(h,"switchCamera"),n("Marked camera switch in session storage")}function k(){return sessionStorage.getItem(h)==="switchCamera"?(sessionStorage.removeItem(h),n("Detected camera switch reload"),!0):(n("Normal page load (not camera switch)"),!1)}function g(e){const t=Array.isArray(e==null?void 0:e.names)?e.names.map(String):[],a=e!=null&&e.collected&&typeof e.collected=="object"?e.collected:{},s={};t.forEach(o=>s[o]=a[o]===void 0?!0:!!a[o]),Object.keys(a).forEach(o=>{a[o]&&(s[o]=!0,t.includes(o)||t.push(o))});const i=Number.isFinite(e==null?void 0:e.t)?e.t:Date.now();return{names:t,collected:s,t:i}}let T=0;const R=()=>({apiSpecId:d.API_SPEC_ID,getRequestHandler(e){const t=(e==null?void 0:e.body)&&(e.body.byteLength??e.body.length)||0;if(n("REQ",`endpoint=${e.endpointId}`,`params=${JSON.stringify(e.parameters||{})}`,`body=${t}B`),e.endpointId==="ping"){const a=++T,s=performance.now();return i=>{i({status:"success",metadata:{n:String(a)},body:c({pong:!0,t:Date.now(),n:a})}),n("RES",`ping #${a}`,`${Math.round(performance.now()-s)}ms`)}}if(e.endpointId==="get_state"){const a=performance.now();return s=>{s({status:"success",metadata:{count:String(r.names.length)},body:c(r)}),n("RES","get_state",`${Math.round(performance.now()-a)}ms`,r)}}if(e.endpointId==="set_state"){const a=performance.now();return s=>{var i;try{let o=(i=e.parameters)==null?void 0:i.payload;if(o==null&&e.body&&(o=L.decode(e.body)),typeof o!="string"){s({status:"bad_request",metadata:{},body:c('missing or invalid "payload" (expected stringified JSON)')});return}const f=JSON.parse(o);r=g(f),v(r),s({status:"success",metadata:{count:String(r.names.length)},body:c({ok:!0})}),n("RES","set_state",`${Math.round(performance.now()-a)}ms`,"Updated gameState:",r)}catch(o){s({status:"server_error",metadata:{},body:c(String((o==null?void 0:o.message)||o))})}}}}});class M{constructor(){this.outputContainer=document.getElementById("app"),this.captureButton=document.getElementById("captureButton"),this.photoPreview=document.getElementById("photoPreview"),this.previewImage=document.getElementById("previewImage"),this.retakeButton=document.getElementById("retakeButton"),this.saveButton=document.getElementById("saveButton"),this.lastCapturedBlob=null,this.cameraKit=null,this.session=null,this.mediaStream=null,this.lensActive=!1,this.currentLens=null,this.currentFacingMode="environment",this.lastTap=0,this.tapTimeout=null,this.backgroundAudio=document.getElementById("backgroundAudio"),this.liveCanvas=null,this.initializeApp()}async initializeApp(){if(k()){const t=A();t&&(r=g(t),n("Restored state from cache after camera switch:",r))}else localStorage.removeItem(u),n("Manual refresh detected - cache cleared, starting fresh");await this.initializeSupabase(),this.setupCaptureButton(),this.setupPreviewControls(),this.setupDoubleTapGesture(),this.setupBackgroundAudio(),await this.initializeCameraKit(),await this.autoStartWithLens()}async initializeSupabase(){try{const{createClient:t}=await w(async()=>{const{createClient:a}=await import("https://esm.sh/@supabase/supabase-js@2");return{createClient:a}},[]);l=t(B,b),console.log("â— Supabase initialized successfully")}catch(t){console.error("â–  Supabase initialization failed:",t)}}setupCaptureButton(){this.captureButton&&this.captureButton.addEventListener("click",()=>{this.photoPreview&&this.photoPreview.classList.contains("show")?this.hidePhotoPreview():this.capturePhoto()})}setupPreviewControls(){this.retakeButton&&this.retakeButton.addEventListener("click",()=>{this.hidePhotoPreview()}),this.saveButton&&this.saveButton.addEventListener("click",()=>{this.saveToSupabase()})}async initializeCameraKit(){try{this.cameraKit=await y({apiToken:d.API_TOKEN,logger:"console"},i=>i.provides(C(S.token,()=>R()))),console.info("[RemoteAPI] provider registered for spec:",d.API_SPEC_ID),this.session=await this.cameraKit.createSession(),window.ckSession=this.session,this.session.events.addEventListener("error",i=>{console.error("Camera Kit error:",i.detail)}),this.liveCanvas=this.session.output.live,this.outputContainer.appendChild(this.liveCanvas),this.liveCanvas.style.width="100%",this.liveCanvas.style.height="100%",this.liveCanvas.style.objectFit="cover",this.liveCanvas.style.display="block",this.liveCanvas.style.background="#000";const a=/iPad|iPhone|iPod/.test(navigator.userAgent)||/Macintosh/.test(navigator.userAgent)&&"ontouchend"in document?1:Math.min(window.devicePixelRatio||1,2),s=()=>{const i=this.liveCanvas.getBoundingClientRect();this.liveCanvas.width=Math.round(i.width*a),this.liveCanvas.height=Math.round(i.height*a),console.log(`Canvas sized: ${this.liveCanvas.width}x${this.liveCanvas.height}`)};new ResizeObserver(s).observe(this.liveCanvas.parentElement),window.addEventListener("orientationchange",s),window.addEventListener("load",s),s()}catch(t){console.error("Failed to initialize Camera Kit:",t)}}async startCamera(){try{this.mediaStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:this.currentFacingMode},frameRate:{ideal:30}},audio:!1});const t=p(this.mediaStream);await this.session.setSource(t),this.currentFacingMode==="user"&&t.setTransform(m.MirrorX),this.session.play("live")}catch(t){console.error("Camera failed:",t),t.name==="OverconstrainedError"&&await this.tryFallbackCamera()}}async tryFallbackCamera(){try{this.mediaStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:this.currentFacingMode}});const t=p(this.mediaStream);await this.session.setSource(t),this.currentFacingMode==="user"&&t.setTransform(m.MirrorX),this.session.play("live")}catch(t){console.error("Fallback camera failed:",t)}}async switchCamera(){if(this.session)try{const t=this.currentFacingMode==="user"?"environment":"user";if(this.currentFacingMode==="user"&&t==="environment"){n("Switching from front to back camera - reloading page"),P(),v(r),this.mediaStream&&this.mediaStream.getTracks().forEach(a=>a.stop()),window.location.reload();return}n("Switching from back to front camera - smooth switch"),this.mediaStream&&this.mediaStream.getTracks().forEach(a=>a.stop()),this.currentFacingMode=t,await this.startCamera(),this.lensActive&&this.currentLens&&await this.session.applyLens(this.currentLens),console.log(`Camera switched to: ${this.currentFacingMode}`)}catch(t){console.error("Switch failed:",t),this.currentFacingMode==="environment"&&(this.currentFacingMode="user")}}async toggleLens(){if(this.session)try{this.lensActive&&this.currentLens?(await this.session.clearLens(),this.lensActive=!1,this.currentLens=null):(this.currentLens=await this.cameraKit.lensRepository.loadLens(d.LENS_ID,d.LENS_GROUP_ID),await this.session.applyLens(this.currentLens),this.lensActive=!0)}catch(t){console.error("Lens error:",t),this.lensActive=!1,this.currentLens=null}}async autoStartWithLens(){try{await this.startCamera(),await new Promise(t=>setTimeout(t,1e3)),await this.toggleLens()}catch(t){console.error("Auto-start failed:",t)}}capturePhoto(){if(!this.session||!this.liveCanvas){console.error("Camera session not ready for capture");return}try{const t=document.createElement("canvas"),a=t.getContext("2d");t.width=this.liveCanvas.width,t.height=this.liveCanvas.height,a.drawImage(this.liveCanvas,0,0),t.toBlob(s=>{if(s){this.lastCapturedBlob=s;const i=URL.createObjectURL(s);this.previewImage&&this.photoPreview?(this.previewImage.src=i,this.showPhotoPreview()):this.downloadPhoto(s),console.log("â— Photo captured!"),this.captureButton&&(this.captureButton.style.transform="scale(0.95)",setTimeout(()=>{this.captureButton.style.transform=""},150))}},"image/png")}catch(t){console.error("Photo capture failed:",t)}}showPhotoPreview(){this.photoPreview&&(this.photoPreview.classList.add("show"),this.captureButton&&(this.captureButton.style.opacity="0.8"))}hidePhotoPreview(){this.photoPreview&&this.photoPreview.classList.remove("show"),this.captureButton&&(this.captureButton.style.opacity="1"),this.saveButton&&(this.saveButton.textContent="â—‹",this.saveButton.disabled=!1),this.previewImage&&this.previewImage.src&&(URL.revokeObjectURL(this.previewImage.src),this.previewImage.src=""),this.lastCapturedBlob=null}async saveToSupabase(){if(!this.lastCapturedBlob||!l){console.error("Cannot save: Missing photo data or Supabase not initialized");return}try{this.saveButton&&(this.saveButton.textContent="â—â—â—",this.saveButton.disabled=!0);const a=`snap-capture-${Date.now()}.png`;console.log("â†‘ Uploading photo to Supabase...");const{data:s,error:i}=await l.storage.from(I).upload(a,this.lastCapturedBlob,{contentType:"image/png"});if(i)throw i;console.log("â— Photo saved to Supabase:",a),this.saveButton&&(this.saveButton.textContent="â—",setTimeout(()=>{this.hidePhotoPreview()},1e3))}catch(t){console.error("â–  Failed to save to Supabase:",t),this.saveButton&&(this.saveButton.textContent="â– ",setTimeout(()=>{this.saveButton.textContent="â†‘",this.saveButton.disabled=!1},2e3))}}downloadPhoto(t=null){const a=t||this.lastCapturedBlob;if(a){const s=URL.createObjectURL(a),i=document.createElement("a");i.href=s,i.download=`snap-capture-${Date.now()}.png`,i.style.display="none",document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(s),console.log("ðŸ’¾ Photo downloaded locally!")}}setupDoubleTapGesture(){const t=this.outputContainer;t.addEventListener("touchend",a=>{a.preventDefault(),this.handleDoubleTap()}),t.addEventListener("click",a=>{a.target.closest("button")||this.handleDoubleTap()})}setupBackgroundAudio(){if(!this.backgroundAudio)return;this.backgroundAudio.volume=.2,this.backgroundAudio.loop=!0;const t=async()=>{try{await this.backgroundAudio.play(),console.log("â— Background audio started"),document.removeEventListener("touchstart",t),document.removeEventListener("click",t),document.removeEventListener("keydown",t)}catch(a){console.error("â–  Audio play failed:",a)}};document.addEventListener("touchstart",t,{once:!0}),document.addEventListener("click",t,{once:!0}),document.addEventListener("keydown",t,{once:!0}),this.backgroundAudio.play().catch(()=>{console.log("Audio autoplay prevented - waiting for user interaction")})}handleDoubleTap(){const t=Date.now(),a=t-this.lastTap;this.tapTimeout&&(clearTimeout(this.tapTimeout),this.tapTimeout=null),a<300&&a>0?(this.switchCamera(),this.lastTap=0):(this.lastTap=t,this.tapTimeout=setTimeout(()=>this.lastTap=0,300))}destroy(){this.mediaStream&&this.mediaStream.getTracks().forEach(t=>t.stop()),this.session&&this.session.destroy().catch(console.error),this.backgroundAudio&&(this.backgroundAudio.pause(),this.backgroundAudio.currentTime=0)}}async function F(){try{window.bayouApp=new M,console.log("ðŸŽ® Bayou AR App initialized with Remote API + Caching + Photo Capture")}catch(e){console.error("Failed to start app:",e);const t=document.getElementById("app");t&&(t.style.color="#fff",t.style.display="grid",t.style.placeItems="center",t.textContent=`App error: ${(e==null?void 0:e.message)||e}`)}}document.addEventListener("DOMContentLoaded",F);window.addEventListener("beforeunload",()=>{window.bayouApp&&window.bayouApp.destroy()});console.log("ðŸš€ Unified Bayou AR script loaded (Remote API + Camera + Caching + Photo Capture)");
